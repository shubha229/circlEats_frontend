<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CirclEats | User Dashboard</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" href="assets/logo.jpg" />

  <style>
    body { background-color: #f9fafb; font-family: "Poppins", sans-serif; }
    header.navbar { background:white; box-shadow:0 2px 4px rgba(0,0,0,0.05); position:sticky; top:0; z-index:50; }
    .navbar nav { display: flex; justify-content: space-between; align-items: center; padding: 0.8rem 1.5rem; } 
    .brand { display: flex; align-items: center; gap: 0.6rem; } 
    .brand img { width: 42px; height: 42px; border-radius: 0.5rem; } 
    .brand span { font-weight: 700; color: #0f766e; font-size: 1.3rem; } 
    .nav-btn { padding: 0.45rem 0.9rem; border-radius: 0.5rem; background: none; border: none; font-weight: 500; cursor: pointer; color: #0f172a; transition: all 0.2s ease; } .nav-btn:hover { background-color: #f3f4f6; } .nav-btn.active { background-color: #0f766e; color: white; } .lang-select { border: 1px solid #d1d5db; border-radius: 0.375rem; padding: 0.25rem 0.5rem; font-size: 0.85rem; } .page-header { text-align: center; padding: 1rem 0.5rem; margin-bottom: 1rem; } .page-header h1 { font-size: 2rem; font-weight: 800; color: #0f766e; margin: 0; } .pointer { cursor: pointer; }
    .dashboard-grid { display:grid; grid-template-columns:300px 1fr; gap:20px; margin-top:2rem; padding:0 2rem; }
    .sidebar { background:white; padding:20px; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.05); }
    .stats-tile { background:#f9fafb; border-radius:10px; padding:1rem; text-align:center; border-left:4px solid #0f766e; }
    .activity-card { background:white; border-left:4px solid #16a34a; padding:1rem; margin-bottom:1rem; border-radius:10px; box-shadow:0 1px 3px rgba(0,0,0,0.05); }
    .Donation { color:#065f46; font-weight:700; }
    .Volunteer { color:#1d4ed8; font-weight:700; }
    .Shelter { color:#92400e; font-weight:700; }
    .activity-time { font-size:0.85rem; color:#6b7280; }
  </style>
</head>

<body class="min-h-screen flex flex-col items-center py-8 px-4"> 
  <!-- Header --> <header class="bg-white shadow-sm sticky top-0 z-40 w-full"> 
    <header class="navbar"> 
      <nav> 
        <div class="brand"> 
          <img src="assets/logo.jpg" alt="CirclEats Logo" /> 
          <span class="pointer" onclick="window.location.href='index.html'">CirclEats</span> 
        </div> 
        
        <div> 
          <button class="nav-btn active">Donor</button> 
          <button onclick="window.location.href='volunteer.html'" class="nav-btn">Volunteer</button> 
          <button onclick="window.location.href='shelter.html'" class="nav-btn">Shelter</button> 
          <button onclick="window.location.href='user-dashboard.html'" class="nav-btn">Profile</button> 
        </div> 
        
        <select id="lang-select" class="lang-select"> 
          <option value="en">English</option> 
          <option value="hi">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</option> 
          <option value="kn">‡≤ï‡≤®‡≥ç‡≤®‡≤°</option> 
          <option value="te">‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å</option> 
        </select> 
      </nav> 
    </header> 
  </header>

  <main class="mt-10">
    <div class="dashboard-grid">

      <!-- LEFT SIDE -->
      <aside class="sidebar">
        <div class="text-center mb-5">
          <h3 class="font-bold text-lg">Welcome üëã</h3>
          <p id="userName" class="text-green-700 font-bold"></p>
          <p id="userEmail" class="text-sm text-gray-500"></p>
        </div>

        <div class="space-y-4">
          <div class="stats-tile">
            <p>Total Donations Created</p>
            <p id="donationCount" class="text-2xl font-bold text-green-700">0</p>
          </div>

          <div class="stats-tile">
            <p>Deliveries Volunteered</p>
            <p id="volunteerCount" class="text-2xl font-bold text-green-700">0</p>
          </div>

          <div class="stats-tile">
            <p>Self Pickups</p>
            <p id="selfPickupCount" class="text-2xl font-bold text-green-700">0</p>
          </div>
        </div>
      </aside>

      <!-- RIGHT SIDE ‚Äì ACTIVITY -->
      <section class="bg-white shadow-md rounded-xl p-6">
        <h2 class="text-2xl font-bold text-center text-green-700 mb-4">
          Your Recent Activity
        </h2>

        <div id="activityList">Loading activity...</div>
      </section>

    </div>
  </main>

  <footer class="text-center py-4 text-gray-500 text-sm mt-10">
    ¬© 2025 CirclEats | Nourishing Communities üíö
  </footer>

  <script>
    const API_BASE = "https://backend-circleats.onrender.com/api";

    function formatDate(id) {
      const ts = parseInt(id.substring(0, 8), 16) * 1000;
      return new Date(ts).toLocaleString();
    }

    async function loadDashboard() {
      const userId = localStorage.getItem("user_id");
      const email = localStorage.getItem("email");
      const name = localStorage.getItem("name");

      document.getElementById("userName").innerText = name || "User";
      document.getElementById("userEmail").innerText = email || "";

      if (!userId) {
        document.getElementById("activityList").innerHTML =
          `<p class='text-red-600 text-center'>User not logged in.</p>`;
        return;
      }

      try {
        const res = await fetch(`${API_BASE}/my_donations/${userId}`);
        const data = await res.json();

        // LEFT SIDE STATS
        document.getElementById("donationCount").innerText = data.length;

        const volunteerCount = data.filter(
          d => d.collected_by === email || d.status === "In Transit"
        ).length;

        const selfPickupCount = data.filter(
          d => d.shelter_request?.self_pickup === true &&
               d.shelter_request?.email === email
        ).length;

        document.getElementById("volunteerCount").innerText = volunteerCount;
        document.getElementById("selfPickupCount").innerText = selfPickupCount;

        // RIGHT SIDE ACTIVITY
        const container = document.getElementById("activityList");
        container.innerHTML = "";

        data.reverse().forEach(item => {
          let type = "";
          let message = "";

          // Self Pickup
          if (item.shelter_request?.self_pickup === true &&
              item.shelter_request?.email === email) {
            type = "Shelter";
            message = `You chose SELF PICKUP for ${item.item}.`;
          }

          // Volunteer
          else if (item.collected_by === email || item.status === "In Transit") {
            type = "Volunteer";
            message = `You volunteered to deliver ${item.item}.`;
          }

          // Donated to shelter
          else if (item.status === "Donated" && item.user_id === userId) {
            type = "Donation";
            message = `You donated ${item.item} to ${item.donated_to}.`;
          }

          // Donation created
          else if (item.status === "Pending") {
            type = "Donation";
            message = `You created a new donation: ${item.item}.`;
          }

          else {
            type = "Donation";
            message = `Donation update: ${item.item}.`;
          }

          const div = document.createElement("div");
          div.className = "activity-card";
          div.innerHTML = `
            <p class="${type}">${type} ‚Äî ${message}</p>
            <p class="activity-time">üìÖ ${formatDate(item._id)}</p>
          `;
          container.appendChild(div);
        });

      } catch (err) {
        console.error(err);
        document.getElementById("activityList").innerHTML =
          `<p class='text-red-600 text-center'>Error loading dashboard data.</p>`;
      }
    }

    document.addEventListener("DOMContentLoaded", loadDashboard);
  </script>

</body>
</html>

